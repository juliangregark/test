<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Stream Viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg: #111111;
      --panel: #0f0f0f;
      --muted: #cfcfcf;
      --accent-blue: #2f80ed;
      --height-top: 56px;
      --chat-width: 360px;
      --placeholder-bg: rgba(255,255,255,0.02);
      --placeholder-inner: rgba(255,255,255,0.01);
      --input-height: 56px;
    }

    *{box-sizing:border-box}
    html,body{
      height:100%;
      margin:0;
      padding:0;
      background:var(--bg);
      color:#fff;
      font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
      -webkit-font-smoothing:antialiased;
    }

    /* Topbar */
    .topbar{
      height:var(--height-top);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 12px;
      background:linear-gradient(180deg,#131313,#0f0f0f);
      border-bottom:1px solid rgba(255,255,255,0.03);
      position:fixed;
      left:0;
      right:0;
      top:0;
      z-index:1000;
    }
    .menu-icon{ width:22px; height:22px; opacity:0.9; }

    /* Main */
    .main{
      display:flex;
      gap:16px;
      height: calc(100vh - var(--height-top));
      padding:16px;
      padding-top: calc(var(--height-top) + 16px);
    }

    .player-area, .sidebar{
      border-radius:8px;
      overflow:hidden;
      position:relative;
      border:1px solid rgba(255,255,255,0.02);
      background:linear-gradient(180deg,#0b0b0b,#010101);
    }

    .player-area{
      flex:1;
      min-height: 420px;
      display:flex;
      align-items:stretch;
      justify-content:stretch;
    }

    .sidebar{
      width:var(--chat-width);
      min-width:260px;
      display:flex;
      flex-direction:column;
    }

    /* Placeholder large panel that looks like image 4:
       big inset rectangle with muted placeholder text and an underline */
    .placeholder {
      margin:18px;
      flex:1;
      border-radius:6px;
      background: linear-gradient(180deg, var(--placeholder-bg), rgba(0,0,0,0.02));
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      min-height: 320px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.6) inset, 0 1px 0 rgba(255,255,255,0.02);
    }

    .placeholder-inner {
      width:calc(100% - 120px);
      max-width:920px;
      background: var(--placeholder-inner);
      padding:18px 18px 8px 18px;
      border-radius:6px;
      display:flex;
      flex-direction:column;
      box-shadow: 0 4px 16px rgba(0,0,0,0.6);
    }

    .placeholder-label {
      color: rgba(255,255,255,0.6);
      font-size:16px;
      margin-bottom:8px;
    }

    /* big, full-width input that visually looks like the provided "favorite movie" image */
    .big-input-wrap {
      display:block;
      width:100%;
      background:transparent;
      padding:0;
    }
    .big-input {
      width:100%;
      height:var(--input-height);
      border:0;
      outline:0;
      background:transparent;
      color:var(--muted);
      font-size:16px;
      padding:12px 14px;
      border-radius:4px;
    }
    /* the inner "tray" to simulate inset area with subtle shadow */
    .big-input-tray {
      background: rgba(0,0,0,0.15);
      border-radius:4px;
      padding:4px;
      box-shadow: inset 0 6px 14px rgba(0,0,0,0.6), 0 1px 0 rgba(255,255,255,0.02);
    }

    /* underline accent under the input */
    .big-underline {
      height:6px;
      margin-top:12px;
      border-radius:4px;
      background: linear-gradient(90deg, rgba(47,128,237,0.95) 0%, rgba(124,58,237,0.9) 100%);
      opacity:0.9;
    }

    /* small inline submit button inside the placeholder's right */
    .submit-btn {
      margin-left:12px;
      background:var(--accent-blue);
      color:#fff;
      border:0;
      padding:10px 14px;
      font-size:16px;
      border-radius:6px;
      cursor:pointer;
      box-shadow:0 6px 14px rgba(47,128,237,0.12);
    }

    /* After loading, iframe should occupy the same area */
    .player-iframe, .chat-iframe {
      width:100%;
      height:100%;
      border:0;
      display:block;
      background:#000;
    }

    /* Sidebar placeholder/header */
    .sidebar .header {
      padding:12px;
      border-bottom:1px solid rgba(255,255,255,0.03);
      color:var(--muted);
      font-weight:600;
    }
    .sidebar .chat-placeholder {
      margin:12px;
      background:var(--placeholder-inner);
      border-radius:6px;
      padding:12px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .chat-input {
      flex:1;
      display:flex;
      flex-direction:column;
    }
    .chat-input .field {
      border:0;
      background:transparent;
      padding:8px 6px;
      color:var(--muted);
      outline:0;
    }
    .chat-input .underline {
      height:4px;
      margin-top:8px;
      background: linear-gradient(90deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border-radius:3px;
    }

    .chat-area {
      flex:1;
      margin:12px;
      border-radius:6px;
      overflow:hidden;
      background: linear-gradient(180deg,#070707,#050505);
      border:1px solid rgba(255,255,255,0.02);
    }

    /* small overlay controls after load so people can change usernames */
    .mini-controls {
      position:absolute;
      top:12px;
      left:12px;
      display:flex;
      gap:8px;
      z-index:40;
      align-items:center;
      background:rgba(0,0,0,0.35);
      padding:6px;
      border-radius:8px;
      backdrop-filter: blur(4px);
    }
    .mini-controls input{
      background:transparent;
      border:1px solid rgba(255,255,255,0.04);
      color:var(--muted);
      padding:6px 8px;
      border-radius:6px;
      font-size:13px;
    }
    .mini-controls button{
      background:transparent;
      color:var(--muted);
      border:1px solid rgba(255,255,255,0.04);
      padding:6px 8px;
      border-radius:6px;
      cursor:pointer;
    }

    /* Responsive */
    @media (max-width:920px){
      .main{ flex-direction:column; padding:12px; padding-top: calc(var(--height-top) + 12px); }
      .sidebar{ width:100%; min-width:unset; height:360px; }
      .player-area{ min-height:280px; }
      .placeholder-inner { width:calc(100% - 48px); }
    }

    /* placeholders for empty states when iframe present but we still want quick-change */
    .hidden{ display:none!important; }
    input::placeholder{ color: rgba(255,255,255,0.32); }
    .focus-white:focus { color:#fff; }
  </style>

  <!-- Twitch Embed SDK (used as primary API for controlling a hidden player where possible) -->
  <script src="https://embed.twitch.tv/embed/v1.js"></script>
</head>
<body>

  <div class="topbar" role="navigation" aria-label="Top bar">
    <div class="left">
      <svg class="menu-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M3 6h18M3 12h18M3 18h18" stroke="#cfcfcf" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </div>
    <div class="right">
      <!-- intentionally left empty to keep the topbar clean -->
    </div>
  </div>

  <main class="main">
    <section class="player-area" aria-label="Stream player area">
      <!-- initial placeholder: big box with input that looks like the provided image -->
      <div id="playerPlaceholder" class="placeholder" aria-hidden="false">
        <div class="placeholder-inner" role="form" aria-label="Load Kick stream">
          <div class="placeholder-label">What's the Kick channel?</div>

          <div class="big-input-tray">
            <div style="display:flex; align-items:center; gap:8px;">
              <div class="big-input-wrap" style="flex:1;">
                <input id="playerBigInput" class="big-input focus-white" placeholder="e.g. crazymangovr" aria-label="Kick username" />
              </div>
              <button id="playerBigSubmit" class="submit-btn" aria-label="Load Kick stream">Load</button>
            </div>
            <div class="big-underline" aria-hidden="true"></div>
          </div>
        </div>
      </div>

      <!-- iframe container (hidden until we load source) -->
      <div id="playerFrameWrap" class="player-iframe hidden" style="width:100%;height:100%;">
        <iframe id="kickEmbed" src="" allowfullscreen allow="autoplay; fullscreen; picture-in-picture" title="Kick player" style="width:100%;height:100%;border:0"></iframe>
      </div>

      <!-- mini controls that show after load for quick swap -->
      <div id="playerMini" class="mini-controls hidden" aria-hidden="true">
        <input id="playerMiniInput" placeholder="Change Kick username" />
        <button id="playerMiniLoad">↻</button>
        <button id="playerMiniClear" title="Clear Kick" aria-label="Clear Kick">✕</button>
      </div>
    </section>

    <aside class="sidebar" aria-label="Chat area">
      <div class="header">Stream Chat</div>

      <!-- chat placeholder similar style -->
      <div id="chatPlaceholder" class="chat-placeholder" aria-hidden="false">
        <div class="chat-input">
          <div style="color:rgba(255,255,255,0.6); font-size:14px; margin-bottom:6px;">Twitch channel</div>
          <input id="chatBigInput" class="field focus-white" placeholder="e.g. crazymangovr" aria-label="Twitch streamer" />
          <div class="underline" aria-hidden="true"></div>
        </div>
        <button id="chatBigSubmit" class="submit-btn" aria-label="Load Twitch chat">Load</button>
      </div>

      <!-- chat iframe container -->
      <div id="chatFrameWrap" class="chat-area hidden" aria-hidden="true">
        <iframe id="twitchChat" class="chat-iframe" src="" title="Twitch chat"></iframe>
      </div>

      <!-- mini controls for chat -->
      <div id="chatMini" class="mini-controls hidden" aria-hidden="true" style="top:8px; right:8px; left:auto;">
        <input id="chatMiniInput" placeholder="Change Twitch username" />
        <button id="chatMiniLoad">↻</button>
        <button id="chatMiniClear" title="Clear Twitch" aria-label="Clear Twitch">✕</button>
      </div>
    </aside>
  </main>

  <!-- Hidden container used to host a tiny Twitch player that will only serve audio (if browser allows) -->
  <div id="hiddenTwitchContainer" style="position:absolute; left:-9999px; top:-9999px; width:1px; height:1px; overflow:hidden; pointer-events:none;">
    <!-- Twitch Player will be created here when needed -->
    <div id="hiddenTwitchPlayer"></div>
  </div>

  <script>
    // localStorage keys
    const LS_KICK_KEY = 'streamViewer.kickUser';
    const LS_TWITCH_KEY = 'streamViewer.twitchUser';

    // Hidden Twitch player reference (SDK or iframe fallback)
    let hiddenTwitchPlayer = null;
    let hiddenTwitchIsSDK = false;

    // Helper: show/hide elements
    function show(el){ el.classList.remove('hidden'); el.setAttribute('aria-hidden','false'); }
    function hide(el){ el.classList.add('hidden'); el.setAttribute('aria-hidden','true'); }

    // Persist helpers
    function saveKickUser(user) {
      if(user) localStorage.setItem(LS_KICK_KEY, user);
      else localStorage.removeItem(LS_KICK_KEY);
    }
    function saveTwitchUser(user) {
      if(user) localStorage.setItem(LS_TWITCH_KEY, user);
      else localStorage.removeItem(LS_TWITCH_KEY);
    }

    // Create or update the hidden Twitch player that will attempt to play audio.
    // Important: modern browsers block autoplay with sound unless there was a user gesture.
    // We therefore call this on explicit Load button clicks (user gesture) to increase chance it will play.
    function createOrUpdateHiddenTwitch(twitchUser) {
      if(!twitchUser) return;

      // If SDK is available, prefer it for programmatic control
      if(window.Twitch && window.Twitch.Player) {
        try {
          // If a player already exists, destroy it to re-create with new channel
          if(hiddenTwitchPlayer && hiddenTwitchIsSDK) {
            try { hiddenTwitchPlayer.remove(); } catch(e){ /* ignore */ }
            hiddenTwitchPlayer = null;
          }

          // create a tiny player - width/height 1 so it's effectively invisible
          // Note: some SDK versions may require a parent param; the SDK uses the embed script
          hiddenTwitchPlayer = new Twitch.Player('hiddenTwitchPlayer', {
            channel: twitchUser,
            width: 1,
            height: 1,
            autoplay: true,
            // muted: false  // we will attempt to unmute below
          });
          hiddenTwitchIsSDK = true;

          // attempt to unmute and set volume (may fail if browser blocks autoplay with sound)
          try {
            if(typeof hiddenTwitchPlayer.setMuted === 'function') {
              hiddenTwitchPlayer.setMuted(false);
            }
            if(typeof hiddenTwitchPlayer.setVolume === 'function') {
              hiddenTwitchPlayer.setVolume(1); // max volume (0..1)
            }
            // attempt to set a lower quality if API supports setQuality (not guaranteed)
            if(typeof hiddenTwitchPlayer.setQuality === 'function') {
              try { hiddenTwitchPlayer.setQuality('160p'); } catch(e){ /* ignore */ }
            }
          } catch(e) {
            // no-op: if browser prevents autoplay with audio, the user will need to interact (click)
            console.warn('Could not programmatically unmute/set volume on hidden Twitch player', e);
          }
          return;
        } catch(e) {
          console.warn('Twitch SDK error while creating hidden player, falling back to iframe', e);
          // fallthrough to iframe fallback
        }
      }

      // Fallback: create a tiny iframe to player.twitch.tv (autoplay may still be blocked)
      try {
        const parent = encodeURIComponent(location.hostname);
        const src = `https://player.twitch.tv/?channel=${encodeURIComponent(twitchUser)}&parent=${parent}&autoplay=true`;
        // create iframe element inside hidden container
        const container = document.getElementById('hiddenTwitchContainer');
        container.innerHTML = `<iframe id="hiddenTwitchIframe" src="${src}" width="1" height="1" frameborder="0" allow="autoplay; fullscreen"></iframe>`;
        hiddenTwitchPlayer = document.getElementById('hiddenTwitchIframe');
        hiddenTwitchIsSDK = false;
      } catch(e) {
        console.warn('Could not create hidden Twitch iframe', e);
      }
    }

    // Destroy hidden twitch player
    function destroyHiddenTwitch() {
      try {
        if(hiddenTwitchIsSDK && hiddenTwitchPlayer && typeof hiddenTwitchPlayer.remove === 'function') {
          hiddenTwitchPlayer.remove();
        } else {
          const container = document.getElementById('hiddenTwitchContainer');
          container.innerHTML = '<div id="hiddenTwitchPlayer"></div>';
        }
      } catch(e) { /* ignore */ }
      hiddenTwitchPlayer = null;
      hiddenTwitchIsSDK = false;
    }

    // Kick load from big placeholder
    function loadKickFromBig() {
      const user = document.getElementById('playerBigInput').value.trim();
      const frame = document.getElementById('kickEmbed');
      if(!user) return;
      frame.src = 'https://player.kick.com/' + encodeURIComponent(user);
      saveKickUser(user);
      show(document.getElementById('playerFrameWrap'));
      show(document.getElementById('playerMini'));
      hide(document.getElementById('playerPlaceholder'));
      document.getElementById('playerMiniInput').value = user;
    }

    // Twitch chat load from panel
    // Additionally: on explicit user Load action we will create the hidden Twitch player (audio) too.
    function loadTwitchFromBig() {
      const user = document.getElementById('chatBigInput').value.trim();
      const frame = document.getElementById('twitchChat');
      if(!user) return;

      const parent = encodeURIComponent(location.hostname);
      frame.src = 'https://www.twitch.tv/embed/' + encodeURIComponent(user) + '/chat?darkpopout&parent=' + parent;
      saveTwitchUser(user);
      show(document.getElementById('chatFrameWrap'));
      show(document.getElementById('chatMini'));
      hide(document.getElementById('chatPlaceholder'));
      document.getElementById('chatMiniInput').value = user;

      // Create/update hidden Twitch player to try to play audio (run on this user gesture)
      try {
        createOrUpdateHiddenTwitch(user);
      } catch (err) {
        console.warn('hidden twitch creation failed', err);
      }
    }

    // Mini control re-load handlers
    function loadKickFromMini(){
      const user = document.getElementById('playerMiniInput').value.trim();
      if(!user) return;
      document.getElementById('kickEmbed').src = 'https://player.kick.com/' + encodeURIComponent(user);
      saveKickUser(user);
    }
    function loadTwitchFromMini(){
      const user = document.getElementById('chatMiniInput').value.trim();
      if(!user) return;
      document.getElementById('twitchChat').src = 'https://www.twitch.tv/embed/' + encodeURIComponent(user) + '/chat?darkpopout&parent=' + encodeURIComponent(location.hostname);
      saveTwitchUser(user);

      // update hidden audio player when user re-loads (user gesture)
      try { createOrUpdateHiddenTwitch(user); } catch (err) { console.warn(err); }
    }

    // Clear handlers (remove from localStorage and restore placeholder)
    function clearKick() {
      document.getElementById('kickEmbed').src = '';
      saveKickUser(null);
      hide(document.getElementById('playerFrameWrap'));
      hide(document.getElementById('playerMini'));
      show(document.getElementById('playerPlaceholder'));
      document.getElementById('playerBigInput').value = '';
      document.getElementById('playerMiniInput').value = '';
    }
    function clearTwitch() {
      document.getElementById('twitchChat').src = '';
      saveTwitchUser(null);
      hide(document.getElementById('chatFrameWrap'));
      hide(document.getElementById('chatMini'));
      show(document.getElementById('chatPlaceholder'));
      document.getElementById('chatBigInput').value = '';
      document.getElementById('chatMiniInput').value = '';

      // destroy hidden twitch audio player when user clears
      destroyHiddenTwitch();
    }

    // Wire up buttons & Enter behavior
    document.getElementById('playerBigSubmit').addEventListener('click', loadKickFromBig);
    document.getElementById('chatBigSubmit').addEventListener('click', loadTwitchFromBig);
    document.getElementById('playerMiniLoad').addEventListener('click', loadKickFromMini);
    document.getElementById('chatMiniLoad').addEventListener('click', loadTwitchFromMini);
    document.getElementById('playerMiniClear').addEventListener('click', clearKick);
    document.getElementById('chatMiniClear').addEventListener('click', clearTwitch);

    document.getElementById('playerBigInput').addEventListener('keydown', function(e){
      if(e.key === 'Enter') loadKickFromBig();
    });
    document.getElementById('chatBigInput').addEventListener('keydown', function(e){
      if(e.key === 'Enter') loadTwitchFromBig();
    });
    document.getElementById('playerMiniInput').addEventListener('keydown', function(e){
      if(e.key === 'Enter') loadKickFromMini();
    });
    document.getElementById('chatMiniInput').addEventListener('keydown', function(e){
      if(e.key === 'Enter') loadTwitchFromMini();
    });

    // On page load: if localStorage has saved values, prefill and auto-load
    window.addEventListener('DOMContentLoaded', function(){
      try {
        const savedKick = localStorage.getItem(LS_KICK_KEY);
        const savedTwitch = localStorage.getItem(LS_TWITCH_KEY);

        if(savedKick) {
          document.getElementById('playerBigInput').value = savedKick;
          // load immediately
          loadKickFromBig();
        }

        if(savedTwitch) {
          document.getElementById('chatBigInput').value = savedTwitch;
          // load immediately and attempt to create hidden audio player
          loadTwitchFromBig();
        }
      } catch (err) {
        // If storage is blocked for any reason, fail silently and keep UI usable
        console.warn('localStorage unavailable', err);
      }
    });
  </script>

</body>
</html>

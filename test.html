<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Stream Viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg: #111111;
      --panel: #0f0f0f;
      --muted: #cfcfcf;
      --accent-blue: #2f80ed;
      --height-top: 56px;
      --chat-width: 360px;
      --placeholder-bg: rgba(255,255,255,0.02);
      --placeholder-inner: rgba(255,255,255,0.01);
      --input-height: 56px;
      --hidden-player-size: 220px;
    }

    *{box-sizing:border-box}
    html,body{
      height:100%;
      margin:0;
      padding:0;
      background:var(--bg);
      color:#fff;
      font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
      -webkit-font-smoothing:antialiased;
    }

    .topbar{
      height:var(--height-top);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 12px;
      background:linear-gradient(180deg,#131313,#0f0f0f);
      border-bottom:1px solid rgba(255,255,255,0.03);
      position:fixed;
      left:0;
      right:0;
      top:0;
      z-index:1000;
    }
    .menu-icon{ width:22px; height:22px; opacity:0.9; }

    .main{
      display:flex;
      gap:16px;
      height: calc(100vh - var(--height-top));
      padding:16px;
      padding-top: calc(var(--height-top) + 16px);
    }

    .player-area, .sidebar{
      border-radius:8px;
      overflow:hidden;
      position:relative;
      border:1px solid rgba(255,255,255,0.02);
      background:linear-gradient(180deg,#0b0b0b,#010101);
    }

    .player-area{
      flex:1;
      min-height: 420px;
      display:flex;
      align-items:stretch;
      justify-content:stretch;
      position:relative;
    }

    .sidebar{
      width:var(--chat-width);
      min-width:260px;
      display:flex;
      flex-direction:column;
    }

    .placeholder {
      margin:18px;
      flex:1;
      border-radius:6px;
      background: linear-gradient(180deg, var(--placeholder-bg), rgba(0,0,0,0.02));
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      min-height: 320px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.6) inset, 0 1px 0 rgba(255,255,255,0.02);
    }

    .placeholder-inner {
      width:calc(100% - 120px);
      max-width:920px;
      background: var(--placeholder-inner);
      padding:18px 18px 8px 18px;
      border-radius:6px;
      display:flex;
      flex-direction:column;
      box-shadow: 0 4px 16px rgba(0,0,0,0.6);
    }

    .placeholder-label {
      color: rgba(255,255,255,0.6);
      font-size:16px;
      margin-bottom:8px;
    }

    .big-input {
      width:100%;
      height:var(--input-height);
      border:0;
      outline:0;
      background:transparent;
      color:var(--muted);
      font-size:16px;
      padding:12px 14px;
      border-radius:4px;
    }

    .big-input-tray {
      background: rgba(0,0,0,0.15);
      border-radius:4px;
      padding:4px;
      box-shadow: inset 0 6px 14px rgba(0,0,0,0.6), 0 1px 0 rgba(255,255,255,0.02);
    }

    .big-underline {
      height:6px;
      margin-top:12px;
      border-radius:4px;
      background: linear-gradient(90deg, rgba(47,128,237,0.95) 0%, rgba(124,58,237,0.9) 100%);
      opacity:0.9;
    }

    .submit-btn {
      margin-left:12px;
      background:var(--accent-blue);
      color:#fff;
      border:0;
      padding:10px 14px;
      font-size:16px;
      border-radius:6px;
      cursor:pointer;
      box-shadow:0 6px 14px rgba(47,128,237,0.12);
    }

    .player-iframe, .chat-iframe {
      width:100%;
      height:100%;
      border:0;
      display:block;
      background:#000;
    }

    .sidebar .header {
      padding:12px;
      border-bottom:1px solid rgba(255,255,255,0.03);
      color:var(--muted);
      font-weight:600;
    }
    .sidebar .chat-placeholder {
      margin:12px;
      background:var(--placeholder-inner);
      border-radius:6px;
      padding:12px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .chat-input { flex:1; display:flex; flex-direction:column; }
    .chat-input .field { border:0; background:transparent; padding:8px 6px; color:var(--muted); outline:0; }
    .chat-input .underline { height:4px; margin-top:8px; background: linear-gradient(90deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)); border-radius:3px; }

    .chat-area { flex:1; margin:12px; border-radius:6px; overflow:hidden; background: linear-gradient(180deg,#070707,#050505); border:1px solid rgba(255,255,255,0.02); }

    .mini-controls {
      position:absolute;
      top:12px;
      left:12px;
      display:flex;
      gap:8px;
      z-index:40;
      align-items:center;
      background:rgba(0,0,0,0.35);
      padding:6px;
      border-radius:8px;
      backdrop-filter: blur(4px);
    }
    .mini-controls input{ background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted); padding:6px 8px; border-radius:6px; font-size:13px; }
    .mini-controls button{ background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.04); padding:6px 8px; border-radius:6px; cursor:pointer; }

    /* small visible container required by Twitch embed to allow autoplay */
    #hiddenTwitchContainer {
      position:fixed;
      left:12px;
      bottom:12px;
      width:var(--hidden-player-size);
      height:var(--hidden-player-size);
      z-index:9999;
      border-radius:8px;
      overflow:hidden;
      background:rgba(0,0,0,0.14);
      box-shadow:0 8px 30px rgba(0,0,0,0.6);
      display:none;
      align-items:center;
      justify-content:center;
      pointer-events:auto;
    }
    #hiddenTwitchContainer.minimal { opacity:0.06; }

    .hidden{ display:none!important; }
    input::placeholder{ color: rgba(255,255,255,0.32); }
    .focus-white:focus { color:#fff; }
    @media (max-width:920px){
      .main{ flex-direction:column; padding:12px; padding-top: calc(var(--height-top) + 12px); }
      .sidebar{ width:100%; min-width:unset; height:360px; }
      .player-area{ min-height:280px; }
      .placeholder-inner { width:calc(100% - 48px); }
      #hiddenTwitchContainer { left:8px; bottom:8px; width:160px; height:160px; }
    }
  </style>

  <script src="https://embed.twitch.tv/embed/v1.js"></script>
</head>
<body>

  <div class="topbar" role="navigation" aria-label="Top bar">
    <div class="left">
      <svg class="menu-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M3 6h18M3 12h18M3 18h18" stroke="#cfcfcf" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </div>
    <div class="right"></div>
  </div>

  <main class="main">
    <section class="player-area" aria-label="Stream player area">
      <!-- visible Twitch video container (initial entry point). When user presses Play, we'll swap to Kick -->
      <div id="twitchVisibleWrap" style="width:100%;height:100%;display:flex;align-items:stretch;justify-content:stretch;">
        <!-- Twitch player will be created into this div by the SDK when a Twitch channel is set to play -->
        <div id="twitchVisiblePlayer" style="width:100%;height:100%;"></div>
      </div>

      <!-- Kick player iframe container (hidden until we decide to show Kick as main) -->
      <div id="kickFrameWrap" class="player-iframe hidden" style="width:100%;height:100%;">
        <iframe id="kickEmbed" src="" allowfullscreen allow="autoplay; fullscreen; picture-in-picture" title="Kick player" style="width:100%;height:100%;border:0"></iframe>
      </div>

      <!-- Controls overlay for user to choose channels / swap manually -->
      <div class="mini-controls" style="right:12px; left:auto;">
        <input id="twitchVideoInput" placeholder="Twitch channel (video) e.g. xqc" />
        <input id="kickInputSmall" placeholder="Kick channel e.g. trainwreckstv" />
        <button id="createTwitchBtn">Load Twitch</button>
      </div>
    </section>

    <aside class="sidebar" aria-label="Chat area">
      <div class="header">Stream Chat</div>

      <div id="chatPlaceholder" class="chat-placeholder" aria-hidden="false">
        <div class="chat-input">
          <div style="color:rgba(255,255,255,0.6); font-size:14px; margin-bottom:6px;">Twitch username (chat)</div>
          <input id="chatBigInput" class="field focus-white" placeholder="e.g. xqc" aria-label="Twitch username" />
          <div class="underline" aria-hidden="true"></div>
        </div>
        <button id="chatBigSubmit" class="submit-btn" aria-label="Load Twitch chat">Load</button>
      </div>

      <div id="chatFrameWrap" class="chat-area hidden" aria-hidden="true">
        <iframe id="twitchChat" class="chat-iframe" src="" title="Twitch chat"></iframe>
      </div>
    </aside>
  </main>

  <!-- Visible small Twitch player container to keep Twitch embed 'playing' in the viewport if needed -->
  <div id="hiddenTwitchContainer" class="minimal" aria-hidden="true" role="region" aria-label="Hidden Twitch audio player">
    <div id="hiddenTwitchPlayer" style="width:100%;height:100%;"></div>
  </div>

  <script>
    // keys
    const LS_TWITCH_KEY = 'streamViewer.twitchUser';
    const LS_KICK_KEY = 'streamViewer.kickUser';

    // SDK players
    let visibleTwitchPlayerSDK = null;     // SDK player in main view
    let hiddenTwitchPlayerSDK = null;      // SDK player kept small in corner (to satisfy embed policy if needed)
    let usingSDK = !!(window.Twitch && window.Twitch.Player);

    // helper show/hide
    const show = el => el.classList.remove('hidden');
    const hide = el => el.classList.add('hidden');

    // create/update visible Twitch SDK player in main area
    function createVisibleTwitch(twitchUser) {
      if(!twitchUser) return;
      // destroy existing visible SDK player if present
      try {
        if(visibleTwitchPlayerSDK && typeof visibleTwitchPlayerSDK.remove === 'function') {
          visibleTwitchPlayerSDK.remove();
          visibleTwitchPlayerSDK = null;
        }
      } catch(e){ console.warn(e); }

      if(usingSDK && window.Twitch && window.Twitch.Player) {
        visibleTwitchPlayerSDK = new Twitch.Player('twitchVisiblePlayer', {
          channel: twitchUser,
          width: '100%',
          height: '100%',
          // autoplay: false -- user must click play; we want them to click
        });

        // Listen for play event. When user clicks Play, Twitch.Player.PLAY is fired.
        try {
          visibleTwitchPlayerSDK.addEventListener(Twitch.Player.PLAY, onTwitchUserPlayed);
        } catch(e) {
          // Some SDK variants use lowercase strings - add fallback
          try { visibleTwitchPlayerSDK.addEventListener('play', onTwitchUserPlayed); } catch(err){ console.warn(err); }
        }
      } else {
        // Fallback: iframe embed (will show native controls)
        const parent = encodeURIComponent(location.hostname);
        const iframeSrc = `https://player.twitch.tv/?channel=${encodeURIComponent(twitchUser)}&parent=${parent}`;
        const container = document.getElementById('twitchVisiblePlayer');
        container.innerHTML = `<iframe id="twitchVisibleIframe" src="${iframeSrc}" width="100%" height="100%" frameborder="0" allow="autoplay; fullscreen"></iframe>`;
        // For iframe fallback we cannot reliably detect "play" event cross-origin.
        // We will attach a click handler overlay to detect the user's manual click as a gesture:
        attachClickGestureDetector(container, twitchUser);
      }
    }

    // Attach an overlay button to detect the user's click gesture on iframe fallback
    function attachClickGestureDetector(container, twitchUser) {
      // remove previous overlay if any
      const prev = container.querySelector('.clickGestureOverlay');
      if(prev) prev.remove();
      const overlay = document.createElement('div');
      overlay.className = 'clickGestureOverlay';
      overlay.style.position = 'absolute';
      overlay.style.left = '0';
      overlay.style.top = '0';
      overlay.style.right = '0';
      overlay.style.bottom = '0';
      overlay.style.cursor = 'pointer';
      overlay.style.zIndex = '1000';
      overlay.style.background = 'transparent';
      overlay.title = 'Click to play and switch to Kick';
      overlay.addEventListener('click', function handler(e){
        // remove overlay so clicks go to the iframe afterwards
        overlay.removeEventListener('click', handler);
        overlay.remove();
        // treat this as user gesture -> trigger the same handler as a PLAY event
        onTwitchUserPlayed({channel: twitchUser});
      });
      container.appendChild(overlay);
    }

    // Called when user clicks Play on visible Twitch player (or our overlay detects a click on iframe fallback)
    function onTwitchUserPlayed(ev) {
      // ev may be an event object or (for overlay) an object containing channel
      // We'll read twitch channel from the small input if available
      const twitchUser = document.getElementById('twitchVideoInput').value.trim() || localStorage.getItem(LS_TWITCH_KEY);
      if(!twitchUser) return;

      // 1) create small visible Twitch player in corner to "keep" the Twitch embed present in viewport (satisfy Twitch)
      createOrUpdateHiddenTwitch(twitchUser);

      // 2) hide/destroy the big visible Twitch player area to reduce bandwidth/visuals:
      //    we keep the small visible Twitch player running (or attempt to)
      try {
        if(visibleTwitchPlayerSDK && typeof visibleTwitchPlayerSDK.remove === 'function') {
          visibleTwitchPlayerSDK.remove();
          visibleTwitchPlayerSDK = null;
        } else {
          // remove iframe if present
          const ifr = document.getElementById('twitchVisibleIframe');
          if(ifr) ifr.remove();
        }
      } catch(e){ console.warn(e); }

      // hide visible wrap and reveal kick area
      const visibleWrap = document.getElementById('twitchVisibleWrap');
      if(visibleWrap) visibleWrap.style.display = 'none';
      const kickWrap = document.getElementById('kickFrameWrap');
      kickWrap.style.display = 'block';
      kickWrap.classList.remove('hidden');

      // 3) load Kick as the visible main player and try to start audio (user gesture already happened)
      const kickUser = document.getElementById('kickInputSmall').value.trim() || localStorage.getItem(LS_KICK_KEY);
      if(kickUser) {
        const kickFrame = document.getElementById('kickEmbed');
        // Kick player should respect autoplay because user just interacted
        kickFrame.src = `https://player.kick.com/${encodeURIComponent(kickUser)}`;
        try { localStorage.setItem(LS_KICK_KEY, kickUser); } catch(e){/*ignore*/}
      }
    }

    // Create or update a small visible Twitch player in the corner (required visible size)
    function createOrUpdateHiddenTwitch(twitchUser) {
      if(!twitchUser) return;
      const container = document.getElementById('hiddenTwitchContainer');
      const playerDiv = document.getElementById('hiddenTwitchPlayer');
      container.style.display = 'flex';
      container.classList.add('minimal');

      // If SDK available, prefer it
      if(usingSDK && window.Twitch && window.Twitch.Player) {
        try {
          if(hiddenTwitchPlayerSDK && typeof hiddenTwitchPlayerSDK.remove === 'function') {
            hiddenTwitchPlayerSDK.remove();
            hiddenTwitchPlayerSDK = null;
          }
          hiddenTwitchPlayerSDK = new Twitch.Player('hiddenTwitchPlayer', {
            channel: twitchUser,
            width: container.clientWidth,
            height: container.clientHeight,
            autoplay: true
          });
          // try to unmute/set volume (may be blocked depending on browser)
          setTimeout(()=> {
            try {
              if(typeof hiddenTwitchPlayerSDK.setMuted === 'function') hiddenTwitchPlayerSDK.setMuted(false);
              if(typeof hiddenTwitchPlayerSDK.setVolume === 'function') hiddenTwitchPlayerSDK.setVolume(1);
            } catch(e){ console.warn('hidden sdk control failed', e); }
          }, 300);
          try { localStorage.setItem(LS_TWITCH_KEY, twitchUser); } catch(e){}
          return;
        } catch(err) {
          console.warn('SDK hidden player failed, falling back to iframe', err);
        }
      }

      // Fallback to iframe (visible)
      try {
        const parent = encodeURIComponent(location.hostname);
        playerDiv.innerHTML = `<iframe id="hiddenTwitchIframe" src="https://player.twitch.tv/?channel=${encodeURIComponent(twitchUser)}&parent=${parent}&autoplay=true" width="100%" height="100%" frameborder="0" allow="autoplay; fullscreen"></iframe>`;
        try { localStorage.setItem(LS_TWITCH_KEY, twitchUser); } catch(e){}
      } catch(e){ console.warn('hidden twitch iframe creation failed', e); }
    }

    // Kick/Chat load helpers for manual usage
    function loadChat() {
      const user = document.getElementById('chatBigInput').value.trim();
      if(!user) return;
      const parent = encodeURIComponent(location.hostname);
      document.getElementById('twitchChat').src = `https://www.twitch.tv/embed/${encodeURIComponent(user)}/chat?darkpopout&parent=${parent}`;
      document.getElementById('chatFrameWrap').classList.remove('hidden');
      try { localStorage.setItem(LS_TWITCH_KEY, user); } catch(e){}
    }

    // Wire basic controls
    document.getElementById('createTwitchBtn').addEventListener('click', function(){
      const tw = document.getElementById('twitchVideoInput').value.trim();
      if(!tw) return alert('Enter a Twitch channel to load the visible player first (so the user can click Play).');
      try { localStorage.setItem(LS_TWITCH_KEY, tw); } catch(e){}
      createVisibleTwitch(tw);
      // ensure visible wrap shown (in case it was hidden from prior swap)
      document.getElementById('twitchVisibleWrap').style.display = 'flex';
      document.getElementById('kickFrameWrap').style.display = 'none';
    });

    document.getElementById('chatBigSubmit').addEventListener('click', loadChat);

    // Reload the small hidden player from a saved value if page loaded with a saved twitch
    window.addEventListener('DOMContentLoaded', function(){
      const savedTwitch = localStorage.getItem(LS_TWITCH_KEY);
      const savedKick = localStorage.getItem(LS_KICK_KEY);
      if(savedTwitch) {
        // create visible twitch player so user can click play (prefer to have them click)
        document.getElementById('twitchVideoInput').value = savedTwitch;
        createVisibleTwitch(savedTwitch);
      }
      if(savedKick) document.getElementById('kickInputSmall').value = savedKick;
      // If you prefer auto-switching to Kick when both exist, you can call createOrUpdateHiddenTwitch + load kick here,
      // but be mindful of autoplay policies; we keep it user-gesture driven.
    });
  </script>
</body>
</html>
